<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Greta App - Frases Tema 5 (Modo Voz)</title>
<style>
body{margin:0;font-family:sans-serif;background:#f9fafb;color:#0f172a}
header{padding:12px;background:#fff;border-bottom:1px solid #e5e7eb;display:flex;justify-content:center}
.mode-btns button{margin:0 6px;padding:8px 14px;border:none;border-radius:14px;font-weight:700;cursor:pointer}
.mode-en{background:#dbeafe}
.mode-es{background:#fde68a}
main{display:flex;justify-content:center;padding:24px}
.card{position:relative;width:100%;max-width:560px;background:#fff;border-radius:28px;padding:32px;box-shadow:0 12px 30px rgba(0,0,0,0.08);text-align:center}
.counter{position:absolute;top:18px;right:22px;font-weight:800;color:#2563eb}
.lang{font-size:14px;font-weight:800;letter-spacing:1px;color:#64748b;margin-bottom:6px}
.audio-btn{width:120px;height:120px;border-radius:50%;border:none;background:#dbeafe;font-size:36px;cursor:pointer;margin:6px auto 10px;display:flex;align-items:center;justify-content:center}
.hidden{display:none}
.es{font-size:20px;color:#2563eb;margin-top:14px}
.en{font-size:20px;color:#0f172a;margin-top:14px;font-weight:700}
.buttons{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:22px}
button.action{padding:16px 0;border:none;border-radius:16px;font-weight:800;cursor:pointer}
.reveal{background:#e0f2fe}
.know{background:#dcfce7}
.next{background:#fbcfe8}
.voice-btn{margin-top:12px;background:#e2e8f0;border:none;padding:10px 14px;border-radius:14px;font-weight:800;cursor:pointer}
.result-box{margin-top:14px;font-weight:800}
.correct{color:#16a34a}
.almost{color:#f59e0b}
.incorrect{color:#dc2626}
</style>
</head>
<body>

<header>
 <div class="mode-btns">
  <button class="mode-en" onclick="setMode('EN')">ANGLÃˆS â†’ CASTELLÃ€</button>
  <button class="mode-es" onclick="setMode('ES')">CASTELLÃ€ â†’ ANGLÃˆS</button>
 </div>
</header>

<main>
<div class="card">
 <div class="counter" id="counter">0 / 12</div>
 <div id="langLabel" class="lang">INGLES</div>
 <button class="audio-btn" onclick="play()">ðŸ”Š</button>
 <button class="voice-btn" onclick="toggleVoice()">ðŸŽ¤ Mode veu</button>

 <div id="es" class="es hidden"></div>
 <div id="en" class="en hidden"></div>

 <div class="buttons">
  <button class="action reveal" onclick="reveal()">Veure</button>
  <button class="action know" onclick="know()">Ja la sÃ©</button>
  <button class="action next" onclick="nextOne()">SegÃ¼ent</button>
 </div>

 <div id="result" class="result-box hidden"></div>
</div>
</main>

<script>

const items = [
{audio:"f001.mp3",en:"Every time I try to organize my desk before starting to work, I end up finding old photographs and letters that distract me for hours, making me realize how much I miss the old days when everything was simpler.",es:"Cada vez que intento organizar mi escritorio antes de empezar a trabajar, acabo encontrando fotografias y cartas viejas que me distraen durante horas, haciendome darme cuenta de cuanto extraÃ±o los viejos tiempos cuando todo era mas sencillo."}
];

let remaining=[...items],current=null,mode="EN",known=0;
let audioPlayer=new Audio();

function updateCounter(){document.getElementById("counter").textContent=known+" / "+items.length;}
function play(){if(current){audioPlayer.src=current.audio;audioPlayer.play();}}

function load(){
 document.getElementById("result").classList.add("hidden");
 current=remaining[Math.floor(Math.random()*remaining.length)];
 document.getElementById("es").classList.add("hidden");
 document.getElementById("en").classList.add("hidden");
 if(mode==="EN"){document.getElementById("langLabel").textContent="INGLES";play();}
 else{document.getElementById("langLabel").textContent="CASTELLANO";
 document.getElementById("es").textContent=current.es;
 document.getElementById("es").classList.remove("hidden");}
}

function reveal(){
 document.getElementById("es").textContent=current.es;
 document.getElementById("en").textContent=current.en;
 document.getElementById("es").classList.remove("hidden");
 document.getElementById("en").classList.remove("hidden");
 if(mode==="ES") play();
}

function know(){remaining=[];known++;updateCounter();load();}
function nextOne(){load();}
function setMode(m){mode=m;load();}

function normalize(t){return t.toLowerCase().replace(/[.,!?]/g,"").replace(/\s+/g," ").trim();}

function similarity(a,b){
 a=normalize(a);b=normalize(b);
 let wa=a.split(" "),wb=b.split(" ");
 let matches=0;
 wa.forEach(w=>{if(wb.includes(w))matches++;});
 return matches/wa.length;
}

const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
let recognition=new SpeechRecognition();
recognition.continuous=true;
recognition.lang="es-ES";

let voiceActive=false;
let waitingAnswer=false;

recognition.onresult=function(e){
 const text=e.results[e.results.length-1][0].transcript.toLowerCase().trim();

 if(!waitingAnswer){
  if(text.includes("contestar")){
   waitingAnswer=true;
   recognition.lang="en-US";
   return;
  }
  if(text.includes("siguiente")){nextOne();}
  if(text.includes("repetir")){play();}
 }else{
  recognition.lang="es-ES";
  waitingAnswer=false;
  evaluate(text);
 }
};

function evaluate(answer){
 const score=similarity(answer,current.en);
 const box=document.getElementById("result");
 box.classList.remove("hidden","correct","almost","incorrect");

 if(score>0.85){box.textContent="âœ” Correcte";box.classList.add("correct");}
 else if(score>0.6){box.innerHTML="âš  Quasi correcta<br>"+answer;box.classList.add("almost");}
 else{box.innerHTML="âœ˜ Incorrecta<br>"+answer;box.classList.add("incorrect");}
}

function toggleVoice(){
 if(!voiceActive){recognition.start();voiceActive=true;alert("Mode veu activat");}
 else{recognition.stop();voiceActive=false;alert("Mode veu desactivat");}
}

updateCounter();
load();

</script>
</body>
</html>
